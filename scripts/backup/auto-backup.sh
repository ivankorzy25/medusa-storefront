#!/bin/bash

# Auto-Backup Script para Medusa Storefront
# Hace backup completo del cรณdigo frontend y lo sube a GitHub

set -e

# Colores para output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}  Medusa Storefront - Auto Backup${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
BACKUP_DIR="backups/builds"

# Crear directorio de backups si no existe
mkdir -p "$BACKUP_DIR"

# 1. Verificar si hay cambios
echo -e "${BLUE}[1/4] ๐ Verificando cambios...${NC}"
git add .

if git diff --cached --quiet; then
    echo -e "${YELLOW}   โน๏ธ  No hay cambios para respaldar${NC}"
    exit 0
fi

# 2. Mostrar resumen de cambios
echo -e "${GREEN}   โ Cambios detectados${NC}"
CHANGES=$(git diff --cached --shortstat)
echo -e "${BLUE}   ๐ $CHANGES${NC}"
echo ""

# 3. Crear backup de build si existe
echo -e "${BLUE}[2/4] ๐ฆ Creando backup de build...${NC}"
if [ -d ".next" ]; then
    BUILD_BACKUP="$BACKUP_DIR/build-$(date +"%Y%m%d_%H%M%S").tar.gz"
    tar -czf "$BUILD_BACKUP" .next > /dev/null 2>&1
    echo -e "${GREEN}   โ Build respaldado en $BUILD_BACKUP${NC}"

    # Mantener solo los รบltimos 5 backups de build
    cd "$BACKUP_DIR"
    ls -t build-*.tar.gz 2>/dev/null | tail -n +6 | xargs -r rm --
    cd - > /dev/null
else
    echo -e "${YELLOW}   โ๏ธ  No hay build para respaldar${NC}"
fi
echo ""

# 4. Crear commit
echo -e "${BLUE}[3/4] ๐พ Creando commit...${NC}"
COMMIT_MSG="๐ Auto-backup Storefront: $TIMESTAMP

Changes: $CHANGES

Frontend backup - Generated by Medusa Auto-Backup System"

if git commit -m "$COMMIT_MSG" > /dev/null 2>&1; then
    echo -e "${GREEN}   โ Commit creado exitosamente${NC}"
    COMMIT_HASH=$(git rev-parse --short HEAD)
    echo -e "${BLUE}   ๐ Commit: $COMMIT_HASH${NC}"
else
    echo -e "${RED}   โ Error al crear commit${NC}"
    exit 1
fi
echo ""

# 5. Push a GitHub
echo -e "${BLUE}[4/4] ๐ Subiendo a GitHub...${NC}"
BRANCH=$(git branch --show-current)

if git push origin "$BRANCH" --quiet 2>/dev/null; then
    echo -e "${GREEN}   โ Push exitoso a origin/$BRANCH${NC}"
else
    echo -e "${YELLOW}   โ๏ธ  Push fallรณ - cambios guardados localmente${NC}"
    echo -e "${YELLOW}   ๐ก Ejecuta manualmente: git push origin $BRANCH${NC}"
fi

echo ""
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}  โ Backup Completado${NC}"
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}   ๐ Timestamp: $TIMESTAMP${NC}"
echo -e "${BLUE}   ๐ Commit: $COMMIT_HASH${NC}"
echo -e "${BLUE}   ๐ฟ Branch: $BRANCH${NC}"
echo ""
